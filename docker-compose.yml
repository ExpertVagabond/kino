version: '3.8'

# Kino - Docker Compose Configuration
#
# Usage:
#   docker-compose up        # Start all services
#   docker-compose up -d     # Start in background
#   docker-compose down      # Stop all services
#   docker-compose logs -f   # View logs

services:
  # Web player service
  player:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    environment:
      - PSM_API_URL=${PSM_API_URL:-}
      - PSM_ANALYTICS_ID=${PSM_ANALYTICS_ID:-}
      - PSM_VERSION=0.1.0
      - PSM_ENV=development
    volumes:
      # Mount web directory for development (hot reload)
      - ./web:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Optional: Media server for HLS content
  media:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./media:/usr/share/nginx/html:ro
      - ./docker/media-nginx.conf:/etc/nginx/nginx.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    profiles:
      - media

  # Optional: Encoding worker
  encoder:
    build:
      context: ./tools/encoding
      dockerfile: Dockerfile.encoder
    volumes:
      - ./input:/input:ro
      - ./output:/output
    environment:
      - ENCODE_PRESET=medium
      - SEGMENT_DURATION=4
    profiles:
      - encoder

networks:
  default:
    name: kino-network
